"""
Initializer â€”â€” é¡¹ç›®åˆå§‹åŒ–å™¨

åŸºäº Anthropic æ–‡ç« çš„è®¾è®¡ï¼š
- ç¬¬ä¸€æ¬¡æ”¶åˆ°éœ€æ±‚æ—¶è¿è¡Œ
- åˆ›å»º init.sh å¯åŠ¨è„šæœ¬
- åˆ›å»º feature_list.json
- åˆå§‹åŒ– git ä»“åº“
"""

from pathlib import Path
from typing import Optional

from config import OUTPUT_DIR
from feature_list import FeatureList


def create_init_script(work_dir: Optional[str] = None) -> str:
    """
    åˆ›å»º init.sh å¯åŠ¨è„šæœ¬
    è¿”å›è„šæœ¬è·¯å¾„
    """
    work_path = Path(work_dir) if work_dir else OUTPUT_DIR
    work_path.mkdir(parents=True, exist_ok=True)

    script = work_path / "init.sh"
    script.write_text("""#!/bin/bash
# MeowDev é¡¹ç›®å¯åŠ¨è„šæœ¬
# ç”±çŒ«çŒ«å›¢é˜Ÿè‡ªåŠ¨ç”Ÿæˆ

set -e

echo "ğŸ± MeowDev åˆå§‹åŒ–..."

# æ£€æŸ¥ Python
if ! command -v python3 &> /dev/null; then
    echo "âŒ éœ€è¦å®‰è£… Python 3"
    exit 1
fi

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
if [ ! -d ".venv" ]; then
    echo "ğŸ“¦ åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv .venv
fi

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source .venv/bin/activate

# å®‰è£…ä¾èµ–ï¼ˆå¦‚æœæœ‰ requirements.txtï¼‰
if [ -f "requirements.txt" ]; then
    echo "ğŸ“¥ å®‰è£…ä¾èµ–..."
    pip install -q -r requirements.txt
fi

echo "âœ… åˆå§‹åŒ–å®Œæˆï¼"
echo ""
echo "è¿è¡Œé¡¹ç›®ï¼š"
echo "  python app.py"
echo ""
""", encoding="utf-8")

    script.chmod(0o755)
    return str(script)


def create_readme(requirement: str, work_dir: Optional[str] = None) -> str:
    """åˆ›å»º README.md"""
    work_path = Path(work_dir) if work_dir else OUTPUT_DIR
    work_path.mkdir(parents=True, exist_ok=True)

    content = f"""# MeowDev é¡¹ç›®

> ç”±ä¸‰åªçŒ«çŒ«ï¼ˆArché…±ã€Stackå–µã€Pixelå’ªï¼‰åä½œç”Ÿæˆ

## éœ€æ±‚

{requirement}

## è¿è¡Œ

```bash
./init.sh
python app.py
```

## åŠŸèƒ½åˆ—è¡¨

å‚è§ `feature_list.json`

## è¿›åº¦è®°å½•

å‚è§ `progress.md`

---
*Generated by MeowDev Team*
"""
    readme_path = work_path / "README.md"
    readme_path.write_text(content, encoding="utf-8")
    return str(readme_path)


async def initialize_project(requirement: str, work_dir: Optional[str] = None) -> dict:
    """
    åˆå§‹åŒ–é¡¹ç›®ï¼ˆç”± Initializer Agent è°ƒç”¨ï¼‰

    è¿”å›åˆ›å»ºçš„æ–‡ä»¶åˆ—è¡¨
    """
    work_path = Path(work_dir) if work_dir else OUTPUT_DIR
    work_path.mkdir(parents=True, exist_ok=True)

    created_files = []

    # 1. åˆ›å»º init.sh
    init_sh = create_init_script(work_dir)
    created_files.append(init_sh)

    # 2. åˆ›å»º README.md
    readme = create_readme(requirement, work_dir)
    created_files.append(readme)

    # 3. åˆå§‹åŒ–ç©ºçš„ feature_list.jsonï¼ˆç”± Arché…± å¡«å……ï¼‰
    fl = FeatureList(work_dir)
    fl._save()  # åˆ›å»ºç©ºæ–‡ä»¶
    created_files.append(str(fl.file_path))

    # 4. åˆå§‹åŒ– progress.md
    from progress import Progress
    prog = Progress(work_dir)
    prog.clear()
    prog.append(f"é¡¹ç›®åˆå§‹åŒ–\néœ€æ±‚: {requirement}", "Initializer")
    created_files.append(str(prog.file_path))

    return {
        "work_dir": str(work_path),
        "files": created_files,
    }
